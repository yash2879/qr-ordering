<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main-layout}">
<head>
    <style>
        /* Custom styles for the availability toggle switch */
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e74a3b; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #1cc88a; }
        input:checked + .slider:before { transform: translateX(26px); }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1055; }
    </style>
</head>
<body>
<div layout:fragment="content">

    <!-- Page Heading -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0 text-gray-800">Menu Management</h1>
            <p class="mb-0 text-muted">Manage all items on your menu.</p>
        </div>
        <a th:href="@{/admin/dashboard/menu/new}" class="btn btn-primary btn-icon-split">
            <span class="icon text-white-50"><i class="fas fa-plus"></i></span>
            <span class="text">Add New Menu Item</span>
        </a>
    </div>

    <!-- NEW: Search and Filter Controls -->
    <div class="card shadow mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-8">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                        </div>
                        <input type="text" id="searchInput" class="form-control" placeholder="Search for a menu item...">
                    </div>
                </div>
                <div class="col-md-4">
                    <select id="availabilityFilter" class="form-control">
                        <option value="all">Show All</option>
                        <option value="yes">Show Available Only</option>
                        <option value="no">Show Unavailable Only</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Current Menu Items</h6>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Price</th>
                        <th>Available</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="menuTableBody">
                    <!-- NEW: Added data-* attributes to the row for easy filtering -->
                    <tr th:each="item : ${menuItems}"
                        th:id="'menu-item-row-' + ${item.id}"
                        th:data-name="${#strings.toLowerCase(item.name)}"
                        th:data-available="${item.available ? 'yes' : 'no'}">

                        <td th:text="${item.id}">1</td>
                        <td th:text="${item.name}">Masala Dosa</td>
                        <td th:text="${'₹' + #numbers.formatDecimal(item.price, 1, 2)}">₹90.00</td>
                        <td>
                            <label class="switch">
                                <input type="checkbox" th:checked="${item.available}" class="availability-toggle" th:data-id="${item.id}">
                                <span class="slider"></span>
                            </label>
                        </td>
                        <td>
                            <a th:href="@{/admin/dashboard/menu/edit/{id}(id=${item.id})}" class="btn btn-warning btn-circle btn-sm" title="Edit">
                                <i class="fas fa-pen"></i>
                            </a>
                            <button class="btn btn-danger btn-circle btn-sm btn-delete"
                                    th:data-id="${item.id}" th:data-name="${item.name}"
                                    data-toggle="modal" data-target="#deleteConfirmModal" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Deletion</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete: <strong id="itemName"></strong>?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div class="toast-container"></div>

    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {

            const searchInput = document.getElementById('searchInput');
            const availabilityFilter = document.getElementById('availabilityFilter');
            const menuTableBody = document.getElementById('menuTableBody');
            const tableRows = menuTableBody.getElementsByTagName('tr');

            function filterMenu() {
                const searchTerm = searchInput.value.toLowerCase();
                const filterValue = availabilityFilter.value;

                // Loop through all table rows
                for (let i = 0; i < tableRows.length; i++) {
                    const row = tableRows[i];
                    const itemName = row.dataset.name;
                    const itemAvailability = row.dataset.available;

                    // Check for matches
                    const nameMatches = itemName.includes(searchTerm);
                    const availabilityMatches = (filterValue === 'all') || (filterValue === itemAvailability);

                    // Show or hide the row
                    if (nameMatches && availabilityMatches) {
                        row.style.display = ""; // Show the row
                    } else {
                        row.style.display = "none"; // Hide the row
                    }
                }
            }

            // Attach event listeners to trigger the filter function
            searchInput.addEventListener('keyup', filterMenu);
            availabilityFilter.addEventListener('change', filterMenu);

            // --- MODAL HANDLING ---
            const deleteModal = $('#deleteConfirmModal');
            let itemToDeleteId = null;

            deleteModal.on('show.bs.modal', function (event) {
                const button = $(event.relatedTarget);
                itemToDeleteId = button.data('id');
                $(this).find('#itemName').text(button.data('name'));
            });

            document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                if (itemToDeleteId) deleteItem(itemToDeleteId);
                deleteModal.modal('hide');
            });

            // --- AVAILABILITY TOGGLE HANDLING ---
            document.querySelectorAll('.availability-toggle').forEach(toggle => {
                toggle.addEventListener('change', function() {
                    updateAvailability(this.dataset.id, this.checked);
                });
            });
        });

        function showToast(message, type = 'success') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = `toast-${Date.now()}`;
            const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';

            const toastHTML = `
                <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-delay="3000">
                    <div class="toast-body text-white ${bgClass}">${message}</div>
                </div>`;
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);

            const toastElement = $(`#${toastId}`);
            toastElement.toast('show');
            toastElement.on('hidden.bs.toast', function () { this.remove(); });
        }

        async function deleteItem(menuItemId) {
            try {
                const response = await fetch(`/api/admin/menu-items/${menuItemId}`, { method: 'DELETE' });
                if (response.ok) {
                    document.getElementById(`menu-item-row-${menuItemId}`)?.remove();
                    showToast('Menu item deleted successfully!');
                } else {
                    showToast('Error: Could not delete the item.', 'danger');
                }
            } catch (error) {
                showToast('An error occurred while deleting.', 'danger');
            }
        }

        async function updateAvailability(menuItemId, isAvailable) {
            try {
                const response = await fetch(`/api/admin/menu-items/${menuItemId}/availability`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isAvailable: isAvailable }) // Ensure the key is 'isAvailable'
                });
                if (response.ok) {
                    showToast('Item availability updated.');
                } else {
                    throw new Error('Server responded with an error.');
                }
            } catch (error) {
                document.querySelector(`.availability-toggle[data-id='${menuItemId}']`).checked = !isAvailable;
                showToast('Error: Could not update availability.', 'danger');
            }
        }
    </script>
</div>
</body>
</html>