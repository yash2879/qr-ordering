<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Kitchen Hub - TableSe</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .order-card {
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin: 10px;
            width: 300px;
            background-color: #f9f9f9;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .order-card.new {
            background-color: #ffffe0; /* Highlight new orders */
            border-color: #ffc107;
        }
        .order-header {
            font-size: 1.2em;
            font-weight: bold;
            border-bottom: 1px solid #ccc;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        #order-container {
            display: flex;
            flex-wrap: wrap;
        }
    </style>
    <!-- 1. Include the necessary JS libraries -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>

<h1>Kitchen Order Display (Restaurant ID: <span th:text="${restaurantId}">1</span>)</h1>
<h2 id="connection-status" style="color: red;">Connecting...</h2>
<div id="order-container">
    <!-- New orders will be added here by JavaScript -->
</div>

<!-- The Notification Sound -->
<audio id="notification-sound" src="https://cdn.pixabay.com/audio/2021/08/04/audio_12b0c7443c.mp3" preload="auto"></audio>


<script th:inline="javascript">
    // 2. Get the restaurant ID from the Thymeleaf model
    const restaurantId = /*[[${restaurantId}]]*/ '1';

    // Get references to HTML elements
    const orderContainer = document.getElementById('order-container');
    const statusDisplay = document.getElementById('connection-status');
    const notificationSound = document.getElementById('notification-sound');

    let stompClient = null;

    function connect() {
        // Create a new WebSocket connection
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            // This function runs on successful connection
            console.log('Connected: ' + frame);
            statusDisplay.textContent = 'Connected';
            statusDisplay.style.color = 'green';

            // 3. Subscribe to the specific topic for this restaurant
            const topic = `/topic/orders/${restaurantId}`;
            stompClient.subscribe(topic, function (message) {
                // This function runs every time a new message is received
                console.log("Received message: ", message.body);
                const order = JSON.parse(message.body);
                displayNewOrder(order);
            });

        }, function(error) {
            // This function runs on connection error
            console.error('STOMP error', error);
            statusDisplay.textContent = 'Disconnected. Retrying...';
            statusDisplay.style.color = 'red';
            setTimeout(connect, 5000); // Retry connection after 5 seconds
        });
    }

    function displayNewOrder(order) {
        // 4. Create a new HTML element for the order
        const orderCard = document.createElement('div');
        orderCard.className = 'order-card new'; // Add 'new' class for highlighting

        let orderItemsHtml = '<ul>';
        // Note: This assumes the 'orderItems' field exists in the JSON.
        // We need to adjust our backend to send this data.
        // For now, let's just show the order ID and table number.
        orderItemsHtml = `Order ID: ${order.id}`;

        orderCard.innerHTML = `
            <div class="order-header">Table: ${order.tableNumber}</div>
            <div>${orderItemsHtml}</div>
            <small>Time: ${new Date(order.orderTime).toLocaleTimeString()}</small>
        `;

        // Add the new order card to the top of the container
        orderContainer.prepend(orderCard);

        // Play the notification sound
        notificationSound.play();

        // Remove the 'new' highlight after a few seconds
        setTimeout(() => {
            orderCard.classList.remove('new');
        }, 5000);
    }

    // 5. Start the connection process when the page loads
    connect();
</script>
</body>
</html>