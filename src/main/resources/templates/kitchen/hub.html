<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/main-layout}">

<head>
    <title>Kitchen Hub - TableSe</title>
    <style>
        /* We keep the same order card styles */
        .order-card {
            border: 2px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .order-card[data-status="NEW"] { background-color: #fff3cd; border-color: #ffeeba; }
        .order-card[data-status="PREPARING"] { background-color: #d1ecf1; border-color: #bee5eb; }
        .order-card[data-status="COMPLETED"] { background-color: #d4edda; border-color: #c3e6cb; }
        .order-actions { margin-top: 15px; }
        .order-container-column {
            min-height: 80vh;
        }
    </style>
</head>

<body>

<div layout:fragment="content">
    <!-- Page Heading -->
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Kitchen Hub (Restaurant ID: <span th:text="${restaurantId}">1</span>)</h1>
        <span id="connection-status" class="badge badge-danger">Connecting...</span>
    </div>

    <!-- The Notification Sound -->
    <audio id="notification-sound" src="https://cdn.pixabay.com/audio/2021/08/04/audio_12b0c7443c.mp3" preload="auto"></audio>

    <!-- Content Row for Kanban-style board -->
    <div class="row">
        <!-- New Orders Column -->
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-warning">New Orders</h6>
                </div>
                <div class="card-body order-container-column" id="new-orders-col">
                    <!-- New orders will be placed here -->
                </div>
            </div>
        </div>
        <!-- Preparing Column -->
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-info">Preparing</h6>
                </div>
                <div class="card-body order-container-column" id="preparing-orders-col">
                    <!-- Preparing orders will be placed here -->
                </div>
            </div>
        </div>
        <!-- Completed Column -->
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-success">Recently Completed</h6>
                </div>
                <div class="card-body order-container-column" id="completed-orders-col">
                    <!-- Completed orders will be placed here -->
                </div>
            </div>
        </div>
    </div>


    <!-- We need to include the JS libraries in the main content fragment -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script th:inline="javascript">
        // --- SETUP ---
        const restaurantId = /*[[${restaurantId}]]*/ '1';
        
        // UI Elements
        const statusDisplay = document.getElementById('connection-status');
        const notificationSound = document.getElementById('notification-sound');
        const newOrdersCol = document.getElementById('new-orders-col');
        const preparingOrdersCol = document.getElementById('preparing-orders-col');
        const completedOrdersCol = document.getElementById('completed-orders-col');
        
        // THE "ORDER STORE": A Map to hold all active orders by their ID.
        const orderStore = new Map();
        
        let stompClient = null;

        // --- DOM MANIPULATION ---

        // THIS IS THE CORRECT, UNIFIED RENDER/UPDATE FUNCTION
        function renderOrUpdateOrder(order, playSound = false) {
            let existingCard = document.getElementById(`order-${order.id}`);

            // ** THIS IS THE CRITICAL FIX **
            // If an order is archived, just remove it from the store and UI, then stop.
            if (order.status === 'ARCHIVED') {
                orderStore.delete(order.id);
                if (existingCard) {
                    existingCard.remove();
                }
                return; // End the function here.
            }

            // Add or update the order in our central store
            orderStore.set(order.id, order);

            // If the card exists, remove it before re-drawing it in the correct column
            if (existingCard) {
                existingCard.remove();
            }
            
            // Re-render the entire board from the updated store
            renderBoard();

            // Play a sound only for genuinely new orders
            if (playSound && order.status === 'NEW') {
                notificationSound.play();
            }
        }
        
        // NEW MASTER RENDER FUNCTION
        function renderBoard() {
            // 1. Clear all columns completely
            newOrdersCol.innerHTML = '';
            preparingOrdersCol.innerHTML = '';
            completedOrdersCol.innerHTML = '';

            if (orderStore.size === 0) {
                newOrdersCol.innerHTML = '<div class="alert alert-info">No active orders right now.</div>';
                return;
            }

            // 2. Iterate through the store and render each order
            orderStore.forEach(order => {
                let targetColumn;
                if (order.status === 'NEW') targetColumn = newOrdersCol;
                else if (order.status === 'PREPARING') targetColumn = preparingOrdersCol;
                else if (order.status === 'COMPLETED') targetColumn = completedOrdersCol;
                else return; // Don't render ARCHIVED or other statuses

                const orderCard = document.createElement('div');
                orderCard.className = 'order-card';
                orderCard.id = `order-${order.id}`;
                orderCard.dataset.status = order.status;

                let orderItemsHtml = '<ul>';
                const items = order.items || order.orderItems;
                items.forEach(item => {
                    const itemName = item.itemName || item.menuItemName || (item.menuItem && item.menuItem.name);
                    orderItemsHtml += `<li>${item.quantity} x ${itemName}</li>`;
                });
                orderItemsHtml += '</ul>';
                
                let actionsHtml = '<div class="order-actions">';
                if (order.status === 'NEW') {
                    actionsHtml += `<button class="btn btn-info btn-sm" onclick="updateStatus(${order.id}, 'PREPARING')">Mark as Preparing</button>`;
                }
                if (order.status === 'PREPARING') {
                    actionsHtml += `<button class="btn btn-success btn-sm" onclick="updateStatus(${order.id}, 'COMPLETED')">Mark as Completed</button>`;
                }
                if (order.status === 'COMPLETED') {
                    actionsHtml += `<button class="btn btn-secondary btn-sm" onclick="dismissOrder(${order.id})">Dismiss</button>`;
                }
                actionsHtml += '</div>';

                orderCard.innerHTML = `
                    <h5>Table: ${order.tableNumber}</h5>
                    <small>Time: ${new Date(order.orderTime).toLocaleTimeString()}</small>
                    <hr class="my-2">
                    ${orderItemsHtml}
                    ${actionsHtml}
                `;
                targetColumn.prepend(orderCard);
            });
        }

        function dismissOrder(orderId) {
            updateStatus(orderId, 'ARCHIVED');
        }

        // --- API & WEBSOCKETS ---
        async function updateStatus(orderId, newStatus) {
            try {
                await fetch(`/api/orders/${orderId}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newStatus: newStatus })
                });
            } catch (error) {
                console.error('Failed to update order status:', error);
                alert('Could not update order status.');
            }
        }
        
        async function fetchInitialOrders() {
            try {
                const response = await fetch(`/api/orders/restaurant/${restaurantId}/active`);
                if (!response.ok) throw new Error("Could not fetch active orders.");
                const initialOrders = await response.json();
                
                // Clear the store before populating
                orderStore.clear();
                initialOrders.forEach(order => {
                    orderStore.set(order.id, order);
                });
                
            } catch (error) {
                console.error("Failed to initialize board:", error);
                newOrdersCol.innerHTML = `<div class="alert alert-danger" id="error-message">Could not load existing orders.</div>`;
            }
        }

        function connectWebSocket() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);
            stompClient.connect({}, frame => {
                statusDisplay.textContent = 'Connected';
                statusDisplay.className = 'badge badge-success';
                const topic = `/topic/orders/${restaurantId}`;
                stompClient.subscribe(topic, message => {
                    const order = JSON.parse(message.body);
                    // The WebSocket message is the single source of truth for an update.
                    renderOrUpdateOrder(order, true);
                });
            }, error => {
                statusDisplay.textContent = 'Disconnected';
                statusDisplay.className = 'badge badge-danger';
                setTimeout(connectWebSocket, 5000);
            });
        }

        // --- INITIALIZATION ---
        async function initializeBoard() {
            newOrdersCol.innerHTML = '<div class="alert alert-info">Loading initial orders...</div>';
            await fetchInitialOrders();
            renderBoard();
            connectWebSocket();
        }
        
        initializeBoard();
    </script>
</div>

</body>
</html>